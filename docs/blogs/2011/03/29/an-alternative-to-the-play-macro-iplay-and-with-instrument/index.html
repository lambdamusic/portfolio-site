




<!DOCTYPE html>
<html lang="en">
  <head>



    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>


    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../../../../media/static/favicon.ico">

	
  <title>Blogs | Michele Pasin</title>


    <!-- Bootstrap core CSS -->
    
    <!-- Bootswatch:  -->
    <!-- cerulean  | cyborg |  flatly |  lumen |  sandstone |   spacelab  |  yeti | cosmo |  darkly |  paper | simplex | superhero |  journal | readable  |   slate |  united -->
    <link href="../../../../../media/static/libs/bootswatch3.2/simplex/bootstrap.min.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="../../../../../media/static/libs/bootstrap-3.3.7-dist/css/ie10-viewport-bug-workaround.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="../../../../../media/static/libs/bootstrap-3.3.7-dist/css/sticky-footer-navbar.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

<style type="text/css">

    .tooltip-inner {
        max-width: 200px;
        /* If max-width does not work, try using width instead */
        width: 200px; 
    }
    .lead-plus {font-size: 26.5px;}
    .label-dark {background: #2c3e50; color: white; padding: 1px;}
    .margin50 {margin-top: 50px; margin-bottom: 50px;}
    .marginb100 {margin-bottom: 100px;}

    .breadcrumbs {margin-top: 80px;}
    .namespaces {background: #ced2d6; width: 100%;}
    .footer {background-color: #3e3f3a;}
    .footer a {color: #cac0bf;}

    .margin50Top {margin-top: 50px;}
    .margin20Top {margin-top: 20px;}
    .margin50Bottom { margin-bottom: 50px;}
    .margin20Bottom { margin-bottom: 20px;}

    /*so that the d3plus tooltip panel doesnt cover the top banner*/
    .navbar {z-index: 3000;}


    .navbar-alpha {
        font-size: 65%;
        font-style: italic;
        font-weight: bold;
        color: darkgoldenrod;
    }


    .btn-xxs {
    padding: 1px 4px;
    font-size: 10px;
    line-height: 1.2;
    border-radius: 2px;
    }


    .code-example {
        overflow: auto;
        height: 400px;
    }


    #side_title a {
        color: blue;
        text-decoration: underline;

    }
    .text-dark {
        color: #5d5c5c;
        
    }


    .paragraph_embed {
      margin-top: 50px;
      margin-bottom: 20px;
    }


    .thumb-div {
      padding: 20px;

    }

    .thumbnail{
      

      

    }

    .thumb-img {
      height: 200px;

    }

    .thumb-title b {
      font-weight: bold;
      color: black;

    }



    a.project-title {
      color: black;
      font-weight: bold;
      text-decoration: none;
    }

    a.project-title:hover {
      background: indianred;
      color: white;
    }

    a.project-active {
      background: indianred;
      color: white;
    }

    .keyword {
      font-style: italic;
      color: grey;
      text-decoration: none;
      font-size: 12px;
    }

    a.paper-active {
      background: indianred;
      color: white;
    }

    a.ext_link {
      color: darkgrey;
    }

    .text-black {
      color: black;
    }

    a.sounds-active {
      background: indianred;
      color: white;
    }

    img.project-screenshots {
      margin-botton: 30px;
    }



    

    .blogentry {
      font-size: 14px;
      margin-top: 50px;
      margin-bottom: 100px;
    }

    .blogentry p:first-of-type {
      font-size: 22px;
      font-weight: bold;
      min-height: 20px;
      padding: 19px;
      margin-bottom: 20px;
      background-color: #f4f4f4;
      border: 1px solid #e3e3e3;
      border-radius: 4px;
      -webkit-box-shadow: inset 0 1px 1px rgb(0 0 0 / 5%);
      box-shadow: inset 0 1px 1px rgb(0 0 0 / 5%);
    }

    .blogentry p {
      margin-top: 40px;
      margin-bottom: 40px;
    }

    .blogentry img {
      max-width: 80%;
    }


</style>








  </head>

  <body>





    

    


<!-- Fixed navbar -->
<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../../../../../index.html">michelepasin<sup style="color: red;">&nbsp;.org</sup></a>
    </div>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav">

        <li >
          <a href="../../../../../index.html">Projects</a></li>

        <li class="active">
            <a href="../../../../../words/index.html">Words</a></li>

       <li >
            <a href="../../../../../sounds/index.html">Sounds</a></li>

        <li >
          <a href="../../../../../events/index.html">Events</a></li>
          
          

        <li 
        
          ><a href="../../../../../about/index.html">About</a></li>

          <!-- <li>
            <a href="/blog" target="_blank">Blog</a></li> -->
            

      </ul>
    </div><!--/.nav-collapse -->

  </div>
</nav>


    








    <!-- Begin page content -->
    <div class="container">


	

  <div class="page-header">
      
      Words > Blogs > 2011 > <i>An alternative to the &#39;play&#39; macro: &#39;iplay&#39; and &#39;with-instrument&#39;</i>
  </div>

  <div class="container">


      <div class="row" style="margin-bottom:50px;">
          
        <div class="col-md-8">


          <p class="text-muted">Title:</p>

          <div class="lead -well">
            <h3><b>An alternative to the &#39;play&#39; macro: &#39;iplay&#39; and &#39;with-instrument&#39;</b></h3>
            
          </div>


          <p class="text-muted">Year:</p>

          <div class="lead -well">
            <h3>2011</h3>
          </div>


            <div class="blogentry"> 

            <p>The other day I was thinking: when I use the <a href="http://moso.com.au/wiki/index.php?title=Play">play macro in Impromptu</a> [<a href="http://impromptu.moso.com.au/resources.html#faq16">video tutorial</a>], in my head it's already <strong>obvious</strong> what's the virtual instrument I want to play. So why do I have to specify that all the time? Wouldn't it be more natural just being able to say, for example, <strong>get this instrument</strong> and now <strong>play this and that note with it</strong>...</p>
<p>Let me clarify this with an example. Let's set up the standard Apple's DLS-synth audiounit and the metronome:</p>
<p>(au:clear-graph)
(define dls     (au:make-node "aumu" "dls " "appl"))
(au:connect-node dls 0 *au:output-node* 0)
(au:update-graph)
(au:print-graph)
(define *metro* (make-metro 100))</p>
<p>Now imagine that we want to play some (dumb) melody with Apple's DLS. We can use the usual <em>play</em> macro to achieve this quite easily (that's because above we set up the metronome, which is needed in order to use <em>play</em> - check out the <a href="http://moso.com.au/wiki/index.php?title=Play">docs</a> if this sounds odd to you).</p>
<p>Sequencing a bunch of notes is thus just a matter of sequencing <em>play</em> macros:</p>
<p>(define the-usual-play
   (lambda (beat) 
      (play dls 60 90 1)
      (play dls 64 90 1)
      (play 1/2 dls 72 90 1)
      (play 3/2 dls 67 90 1)
      (callback (*metro* (+ beat (* 1/2 2))) 'the-usual-play (+ beat 2))))</p>
<p>(the-usual-play (*metro* 'get-beat 4))</p>
<p><strong>That's where I started getting nervous</strong> (so to say). Having to write 'dls' each time I play a new note seemed to me redundant and illogical; I <strong>know</strong> that it's dls the instrument I want to play - I heard my mind screaming - why can't I focus on the music instead of making sure I type in the instrument name all the time?</p>
<h3>Taking advantage of Scheme, the self-modifying language</h3>
<p>Luckily though we're using <a href="http://www.michelepasin.org/blog/2010/08/10/learning-resources-about-scheme/">Scheme</a>, which differently from most other computer languages allows you to change the language grammar as you like, thanks to <a href="http://en.wikipedia.org/wiki/Macro_(computer_science)">macros</a>. So here we go, we can create a new macro similar to <em>play</em> that lets you omit the instrument you're playing. We'll call it <em><strong>iplay</strong></em> (shortcut for instrument-play, not itunes :-)):</p>
<p>(macro (iplay args)<br />
   (cond ((equal? (length (cdr args)) 3)
          `(let ((note ,(cadr args))
                 (vol ,(caddr args))
                 (dur ,(cadddr args))
                 )
              (play my-inst note vol dur)))
         ((equal? (length (cdr args)) 4)
          `(let ((offset ,(cadr args))
                 (note ,(caddr args))
                 (vol ,(cadddr args))
                 (dur ,(cadddr (cdr args))))             <br />
           (play (eval offset) my-inst note vol dur)))
         (#t (print "Error: the function only accepts 3 or 4 argument"))))</p>
<p>Essentially what we're telling the interpreter here is that every time <em>iplay</em> is used, the original <em>play</em> should be called and the symbol <em>my-inst</em> should be passed as the variable representing our instrument. Now we can modify the simple loop defined above like this:</p>
<p>(define the-usual-play-modified
   (lambda (beat) 
      (let ((my-inst dls))
         (iplay 60 90 1)
         (iplay 64 90 1))
      (play 1/2 dls 72 90 1)
      (play 3/2 dls 67 90 1)
      (callback (*metro* (+ beat (* 1/2 2))) 'the-usual-play-modified (+ beat 2))))</p>
<p>(the-usual-play-modified (*metro* 'get-beat 4))</p>
<p>If you run that, you'll see that this loop sounds exactly the same as the previous one, although the first two <em>play</em> calls are now <em><strong>iplay</strong></em> macro calls. The whole thing works because we introduced a local variable <em>my-inst</em> and bound that to the dls audio instrument (created at the beginning). Notice that <strong>the new macro <em>iplay</em> knows nothing about what instrument is playing</strong>: it's just using blindly the <em>my-inst</em> variable, under the assumption that we've associated it to a valid audio instrument.</p>
<h3>Some more syntactic sugar</h3>
<p>The only hassle now is that each time we want to use <em>iplay</em> we are forced to use the <em>(let ((my-inst dls))..</em> form. Typing this stuff doesn't feel very natural too. Rather, in my head, I tend to see things like this: get an instrument first, then play a bunch of notes with it.</p>
<p>So, let's create some syntactic sugar for the '<em>let</em>' form, by defining another macro, '<em>with-instrument</em>':</p>
<p>(macro (with-instrument args)
   `(let ((my-inst ,(cadr args)))
       ,@(cddr args)))</p>
<p>As you can see, this macro doesn't do much: it just rephrases the <em>let</em> form above in a way that is probably more natural to me (and to others too I believe..).</p>
<p>For example, now we can use <em>iplay</em> like this:</p>
<p>(define justatest
   (lambda (beat)    <br />
      (with-instrument dls 
          (iplay 48 40 1)  ;; iplay with 3 args: pitch, vol and dur
          (iplay (random (list 1/2 1/4 1/8)) (random 60 80) 40 1))  ;; 4 arguments: offset
      (callback (*metro* (+ beat (* 1/2 1))) 'justatest (+ beat 1))))</p>
<p>(justatest (*metro* 'get-beat 4))</p>
<p>Finally, <strong>let's remember</strong> that because of the way we defined <em>iplay</em> above, we can pass it 3 or 4 arguments: in the first case, the macro assumes that we're providing a <strong>pitch</strong>, a <strong>volume</strong>, and a <strong>duration</strong>. In the second case instead the first argument is assumed to be an <strong>offset</strong> value (while the others remain unchanged).</p>
<p>The <a href="http://moso.com.au/wiki/index.php?title=Play">original <em>play</em> macro</a> can take another argument too: the <strong>channel</strong> (or midi port). I haven't included here cause I normally don't need it, but if you do I'm sure you can fiddle a bit with the code above and make it do whatever you want!</p>
<p>Conclusion: here is the code you need to evaluate within Impromptu if you want to use the with/iplay constructs (all the source code is also available on <a href="https://bitbucket.org/magicrebirth/impromptu_public/src/tip/_libs/playau.scm">BitBucket</a>):</p>
<p>(macro (with-instrument args)
   `(let ((my-inst ,(cadr args)))
       ,@(cddr args)))</p>
<p>(macro (iplay args)
   (cond ((equal? (length (cdr args)) 3)
          `(let ((note ,(cadr args))
                 (vol ,(caddr args))
                 (dur ,(cadddr args))
                 )
              ;(print inst beat note vol dur)
              (play my-inst note vol dur)))
         ((equal? (length (cdr args)) 4)
          `(let ((offset ,(cadr args))
                 (note ,(caddr args))
                 (vol ,(cadddr args))
                 (dur ,(cadddr (cdr args))))
           ;(print inst beat note vol dur)
           (play (eval offset) my-inst note vol dur)))
         (#t (print "Error: the function only accepts 3 or 4 argument"))))</p>
<h3>Finally.. a 'pastebin' function</h3>
<p>Also, here is a pastebin function similar to <a href="http://moso.com.au/wiki/index.php?title=Pb:cb">pb:cb</a> (check out this <a href="http://impromptu.moso.com.au/resources.html#faq15">video tutorial</a> if you don't know what I'm talking about) that returns a template with the <em>with-instrument</em> macro:</p>
<p>(define pb:iplay (lambda (name dur inst) '()))  ;; fake function definition, useful for autocompletion!</p>
<p>;; macro wrapper for pb-iplay
(define-macro (pb:iplay name dur inst . args)
   `(pb-iplay (sexpr-&gt;string (quote ,name)) 
              (sexpr-&gt;string (quote ,dur))
              (sexpr-&gt;string (quote ,inst))
              ,@(map (lambda (expr)
                        (sexpr-&gt;string expr))
                     args)))</p>
<p>(define pb-iplay
   (lambda (name dur inst . args)
      (let ((a (apply string-append (map (lambda (e) (string-append "n      " e)) args))))
         (sys:set-pasteboard
         (string-append 
"(define " name "
   (lambda (beat) 
      (with-instrument " inst "
          " a "
     (callback (*metro* (+ beat (* 1/2 " dur "))) '" name " (+ beat " dur ")))))nn(" name " (*metro* 'get-beat 4))")))))</p>
<p>;;;;;;;;;;;;;;;;
;; call it like this: 
;(pb:iplay myloop 1/4 dls)
;;</p>
<p>;;;;;;;;;;;;;;;;;
;; returns: 
;;;;;;;;;;;;;;;;</p>
<p>;
;(define myloop
;   (lambda (beat) 
;      (with-instrument dls
;
;     (callback (*metro* (+ beat (* 1/2 1/4))) 'myloop (+ beat 1/4)))))
;
;(myloop (*metro* 'get-beat 4))</p>

            </div>


          <hr>
            <p class="text-muted">Cite this article:</p>

            <div class="well well-big lead">
              Michele Pasin. <a href="index.html" class="bluelink">An alternative to the &#39;play&#39; macro: &#39;iplay&#39; and &#39;with-instrument&#39;</a>. Blog post on www.michelepasin.org. Published on March 29, 2011.
            </div>
            <br />

        


          <br /><br />


        </div> 
        
      

        <div class="col-md-1 col-md-offset-1">


            
            <p class="text-muted">Linkout:</p>

            <div class="-lead">

              
              <li><a href="https://www.michelepasin.org/blog/2011/03/29/an-alternative-to-the-play-macro-iplay-and-with-instrument/index.html">Legacy Blog</a></li>
                
              

            </div>
            <br />
            


        </div>
        
      </div>




      

      





    <div class="row">
      <h5 class="text-muted">See also:</h5>
      </div>


      

      <div class="row row_pubitem">

        <hr>

        <div class="col-sm-2 col-md-3">
          <p style="color: lightgrey; font-size: 300%; ">2011</p>
        </div>


        <div class="col-sm-7 col-md-9">


        

        <br />

          <div class='pubitem'>

            <small class="text-muted">Mar 2011</small>

            <p class='lead' style="font-size: 13px;">
              <a href="index.html" class="bluelink paper-active">An alternative to the &#39;play&#39; macro: &#39;iplay&#39; and &#39;with-instrument&#39;</a>.
              <br />
              <span class="">Michele Pasin</span>
            </p>

            <p class="pubinfo text-muted" style="margin-top: -15px;">

              
                <span class='journal'> Blog entry on www.michelepasin.org .,</span>
              
              
              
              
                <span class='pubdate'> Mar 2011.</span>
              
              
              
              
              

            </p>

            


          </div>

        


        </div>



      </div>

      








    <div class="row" style="margin-top: 60px;">
    &nbsp;
    </div> 
    



  </div> <!-- /container -->





	</div>


  



  




  <footer class="footer">
    <div class="container">
    
      <p class="text-muted">Find me also on: &nbsp;
      

  <a href="http://kcl.academia.edu/MichelePasin" target="_blank">Academia</a> | 
  <a href="https://github.com/lambdamusic" target="_blank">GitHub</a> | 
  <a href="https://scholar.google.com/citations?user=zj-99x0AAAAJ&hl=en" target="_blank">Google Scholar</a> | 
  <a href="https://www.instagram.com/lambdamusic/" target="_blank">Instagram</a> |
  <a href="http://www.linkedin.com/pub/michele-pasin/1/223/a0" target="_blank">LinkedIn</a> |
  <a href="http://www.mendeley.com/profiles/michele-pasin/" target="_blank">Mendeley</a> |
  <a href="http://orcid.org/0000-0001-8909-7766" target="_blank">Orcid</a> |
  <a href="http://www.slideshare.net/mpasin" target="_blank">SlideShare</a> |
  <a href="https://soundcloud.com/magicrebirth" target="_blank">Soundcloud</a> |
  <a href="http://stackoverflow.com/users/109304/magicrebirth" target="_blank">StackOverflow</a> |
  <a href="http://twitter.com/#!/lambdaman" target="_blank">Twitter</a> |
  <a href="https://vimeo.com/lambdamusic" target="_blank">Vimeo</a>
      
      </p>
    
    </div>
  </footer>


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../../../../../media/static/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="../../../../../media/static/libs/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../../../../../media/static/libs/bootstrap-3.3.7-dist/js/ie10-viewport-bug-workaround.js"></script>


    



    

  </body>
</html>
