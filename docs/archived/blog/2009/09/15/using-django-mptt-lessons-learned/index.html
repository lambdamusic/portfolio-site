<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
	<head profile="http://gmpg.org/xfn/11">
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<title>Parerga und Paralipomena  &raquo; Blog Archive   &raquo; Using Django-MPTT: lessons learned&#8230;		</title>
		<meta name="generator" content="WordPress 5.2.11" /> <!-- leave this for stats -->
		<link rel="stylesheet" href="../../../../wp-content/themes/ub_modio/style.css" type="text/css" media="screen" />
		<link rel="alternate" type="application/rss+xml" title="Parerga und Paralipomena RSS Feed" href="../../../../feed/index.html" />
		<link rel="pingback" href="http://www.michelepasin.org/blog/xmlrpc.php" />
		
		<!--[if lte IE 6]>
		<link rel="stylesheet" type="text/css" href="http://www.michelepasin.org/blog/wp-content/themes/ub_modio/ie.css">
		<![endif]-->
		<link rel="shortcut icon" href="http://www.michelepasin.org/blog/2009/09/15/using-django-mptt-lessons-learned/favicon.ico">
<link rel='dns-prefetch' href='http://secure.gravatar.com/' />
<link rel='dns-prefetch' href='http://s.w.org/' />
<link rel="alternate" type="application/rss+xml" title="Parerga und Paralipomena &raquo; Using Django-MPTT: lessons learned&#8230; Comments Feed" href="feed/index.html" />
<!-- This site uses the Google Analytics by MonsterInsights plugin v7.15.1 - Using Analytics tracking - https://www.monsterinsights.com/ -->
<script type="text/javascript" data-cfasync="false">
    (window.gaDevIds=window.gaDevIds||[]).push("dZGIzZG");
	var mi_version         = '7.15.1';
	var mi_track_user      = true;
	var mi_no_track_reason = '';
	
	var disableStr = 'ga-disable-UA-2000254-3';

	/* Function to detect opted out users */
	function __gaTrackerIsOptedOut() {
		return document.cookie.indexOf(disableStr + '=true') > -1;
	}

	/* Disable tracking if the opt-out cookie exists. */
	if ( __gaTrackerIsOptedOut() ) {
		window[disableStr] = true;
	}

	/* Opt-out function */
	function __gaTrackerOptout() {
	  document.cookie = disableStr + '=true; expires=Thu, 31 Dec 2099 23:59:59 UTC; path=/';
	  window[disableStr] = true;
	}

	if ( 'undefined' === typeof gaOptout ) {
		function gaOptout() {
			__gaTrackerOptout();
		}
	}
	
	if ( mi_track_user ) {
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','__gaTracker');

		__gaTracker('create', 'UA-2000254-3', 'auto');
		__gaTracker('set', 'forceSSL', true);
		__gaTracker('send','pageview');
	} else {
		console.log( "" );
		(function() {
			/* https://developers.google.com/analytics/devguides/collection/analyticsjs/ */
			var noopfn = function() {
				return null;
			};
			var noopnullfn = function() {
				return null;
			};
			var Tracker = function() {
				return null;
			};
			var p = Tracker.prototype;
			p.get = noopfn;
			p.set = noopfn;
			p.send = noopfn;
			var __gaTracker = function() {
				var len = arguments.length;
				if ( len === 0 ) {
					return;
				}
				var f = arguments[len-1];
				if ( typeof f !== 'object' || f === null || typeof f.hitCallback !== 'function' ) {
					console.log( 'Not running function __gaTracker(' + arguments[0] + " ....) because you are not being tracked. " + mi_no_track_reason );
					return;
				}
				try {
					f.hitCallback();
				} catch (ex) {

				}
			};
			__gaTracker.create = function() {
				return new Tracker();
			};
			__gaTracker.getByName = noopnullfn;
			__gaTracker.getAll = function() {
				return [];
			};
			__gaTracker.remove = noopfn;
			window['__gaTracker'] = __gaTracker;
					})();
		}
</script>
<!-- / Google Analytics by MonsterInsights -->
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/12.0.0-1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/12.0.0-1\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/www.michelepasin.org\/blog\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.2.11"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])?!1:!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([55357,56424,55356,57342,8205,55358,56605,8205,55357,56424,55356,57340],[55357,56424,55356,57342,8203,55358,56605,8203,55357,56424,55356,57340])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='wp-block-library-css'  href='../../../../wp-includes/css/dist/block-library/style.min.css%3Fver=5.2.11.css' type='text/css' media='all' />
<style id='wp-block-library-inline-css' type='text/css'>
.has-text-align-justify{text-align:justify;}
</style>
<link rel='stylesheet' id='ctf_styles-css'  href='../../../../wp-content/plugins/custom-twitter-feeds/css/ctf-styles.min.css%3Fver=1.7.css' type='text/css' media='all' />
<link rel='stylesheet' id='monsterinsights-popular-posts-style-css'  href='../../../../wp-content/plugins/google-analytics-for-wordpress/assets/css/frontend.min.css%3Fver=7.15.1.css' type='text/css' media='all' />
<link rel='stylesheet' id='wordpress-popular-posts-css-css'  href='../../../../wp-content/plugins/wordpress-popular-posts/assets/css/wpp.css%3Fver=5.2.4.css' type='text/css' media='all' />
<link rel='stylesheet' id='jetpack_css-css'  href='../../../../wp-content/plugins/jetpack/css/jetpack.css%3Fver=8.1.2.css' type='text/css' media='all' />
<script type='text/javascript'>
/* <![CDATA[ */
var monsterinsights_frontend = {"js_events_tracking":"true","download_extensions":"doc,pdf,ppt,zip,xls,docx,pptx,xlsx","inbound_paths":"[]","home_url":"http:\/\/www.michelepasin.org\/blog","hash_tracking":"false"};
/* ]]> */
</script>
<script type='text/javascript' src='../../../../wp-content/plugins/google-analytics-for-wordpress/assets/js/frontend.min.js%3Fver=7.15.1'></script>
<script type='application/json' id="wpp-json">
{"sampling_active":0,"sampling_rate":100,"ajax_url":"http:\/\/www.michelepasin.org\/blog\/wp-json\/wordpress-popular-posts\/v1\/popular-posts","ID":318,"token":"10a27ddbef","lang":0,"debug":0}
</script>
<script type='text/javascript' src='../../../../wp-content/plugins/wordpress-popular-posts/assets/js/wpp.min.js%3Fver=5.2.4'></script>
<script type='text/javascript' src='../../../../wp-includes/js/jquery/jquery.js%3Fver=1.12.4-wp'></script>
<script type='text/javascript' src='../../../../wp-includes/js/jquery/jquery-migrate.min.js%3Fver=1.4.1'></script>
<link rel='https://api.w.org/' href='../../../../wp-json/index.html' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../../../../xmlrpc.php%3Frsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="../../../../wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='Learning iPhone development while sitting on your couch' href='../../13/learning-iphone-development-while-sitting-on-your-couch/index.html' />
<link rel='next' title='Project: django SOCLONE' href='../../28/project-django-soclone/index.html' />
<meta name="generator" content="WordPress 5.2.11" />
<link rel="canonical" href="index.html" />
<link rel='shortlink' href='https://wp.me/pW0Ls-58' />
<link rel="alternate" type="application/json+oembed" href="../../../../wp-json/oembed/1.0/embed%3Furl=http:%252F%252Fwww.michelepasin.org%252Fblog%252F2009%252F09%252F15%252Fusing-django-mptt-lessons-learned%252F" />
<link rel="alternate" type="text/xml+oembed" href="../../../../wp-json/oembed/1.0/embed%3Furl=http:%252F%252Fwww.michelepasin.org%252Fblog%252F2009%252F09%252F15%252Fusing-django-mptt-lessons-learned%252F&amp;format=xml" />
<style data-context="foundation-flickity-css">/*! Flickity v2.0.2
http://flickity.metafizzy.co
---------------------------------------------- */.flickity-enabled{position:relative}.flickity-enabled:focus{outline:0}.flickity-viewport{overflow:hidden;position:relative;height:100%}.flickity-slider{position:absolute;width:100%;height:100%}.flickity-enabled.is-draggable{-webkit-tap-highlight-color:transparent;tap-highlight-color:transparent;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.flickity-enabled.is-draggable .flickity-viewport{cursor:move;cursor:-webkit-grab;cursor:grab}.flickity-enabled.is-draggable .flickity-viewport.is-pointer-down{cursor:-webkit-grabbing;cursor:grabbing}.flickity-prev-next-button{position:absolute;top:50%;width:44px;height:44px;border:none;border-radius:50%;background:#fff;background:hsla(0,0%,100%,.75);cursor:pointer;-webkit-transform:translateY(-50%);transform:translateY(-50%)}.flickity-prev-next-button:hover{background:#fff}.flickity-prev-next-button:focus{outline:0;box-shadow:0 0 0 5px #09f}.flickity-prev-next-button:active{opacity:.6}.flickity-prev-next-button.previous{left:10px}.flickity-prev-next-button.next{right:10px}.flickity-rtl .flickity-prev-next-button.previous{left:auto;right:10px}.flickity-rtl .flickity-prev-next-button.next{right:auto;left:10px}.flickity-prev-next-button:disabled{opacity:.3;cursor:auto}.flickity-prev-next-button svg{position:absolute;left:20%;top:20%;width:60%;height:60%}.flickity-prev-next-button .arrow{fill:#333}.flickity-page-dots{position:absolute;width:100%;bottom:-25px;padding:0;margin:0;list-style:none;text-align:center;line-height:1}.flickity-rtl .flickity-page-dots{direction:rtl}.flickity-page-dots .dot{display:inline-block;width:10px;height:10px;margin:0 8px;background:#333;border-radius:50%;opacity:.25;cursor:pointer}.flickity-page-dots .dot.is-selected{opacity:1}</style><style data-context="foundation-slideout-css">.slideout-menu{position:fixed;left:0;top:0;bottom:0;right:auto;z-index:0;width:256px;overflow-y:auto;-webkit-overflow-scrolling:touch;display:none}.slideout-menu.pushit-right{left:auto;right:0}.slideout-panel{position:relative;z-index:1;will-change:transform}.slideout-open,.slideout-open .slideout-panel,.slideout-open body{overflow:hidden}.slideout-open .slideout-menu{display:block}.pushit{display:none}</style>
<link rel='dns-prefetch' href='http://v0.wordpress.com/'/>
<style type='text/css'>img#wpstats{display:none}</style>
<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content="Using Django-MPTT: lessons learned&#8230;" />
<meta property="og:url" content="http://www.michelepasin.org/blog/2009/09/15/using-django-mptt-lessons-learned/" />
<meta property="og:description" content="Here we are again with Django and MPTT 0.3 (I already have other posts about it). After working with it for a bit I realized that things were breaking mysteriously, and only recently understood why…" />
<meta property="article:published_time" content="2009-09-15T16:35:59+00:00" />
<meta property="article:modified_time" content="2009-09-15T16:35:59+00:00" />
<meta property="og:site_name" content="Parerga und Paralipomena" />
<meta property="og:image" content="https://s0.wp.com/i/blank.jpg" />
<meta property="og:locale" content="en_US" />
<meta name="twitter:text:title" content="Using Django-MPTT: lessons learned&#8230;" />
<meta name="twitter:card" content="summary" />

<!-- End Jetpack Open Graph Tags -->
<style>.ios7.web-app-mode.has-fixed header{ background-color: rgba(3,122,221,.88);}</style>			<style type="text/css" id="wp-custom-css">
				.entry ul li {
	list-style: disc;
}

.entry ol li {
	list-style: lower-roman;
}

			</style>
			</head>
	<body>
		<div class="page">
			<div id="header">
				<a href="../../../../index.html">Parerga und Paralipomena</a> / <span class="description">At the core of all well-founded belief lies belief that is unfounded &#8211; Wittgenstein</span><span style="float:right;"><a href="../../../../feed/index.html" title="">
						<img src="../../../../wp-content/themes/ub_modio/images/rss_black.png" alt="Parerga und Paralipomena Feed" width="14" height="14"/>
					</a>
				</span>
			</div><!-- end header --><div id="content" class="widecolumn">

		<div class="post" id="post-318">
		<h2><a href="index.html" rel="bookmark" title="Permanent Link: Using Django-MPTT: lessons learned&#8230;">Using Django-MPTT: lessons learned&#8230;</a>
		</h2>
		<div class="entry">
				<p>Here we are again with Django and <a href="http://code.google.com/p/django-mptt/">MPTT</a> 0.3 (I already have <a href="../../../../index.html%3Fp=275.html">other posts about it</a>). After working with it for a bit I realized that <strong>things were breaking mysteriously</strong>, and only recently understood why that happened, so I thought I&#8217;d share this pearl of wisdom. Essentially this has to do with the way tree-elements must be created if you want the usual tree-navigation methods (e.g. <em>get_descendants</em> or <em>get_ancestors</em>)  to work as expected.</p>
<p>Suppose your Django model looks like this:</p>
<pre><div class="python" style="font-family:monospace;color: #006; border: 1px solid #d0d0d0; background-color: #f0f0f0;overflow:auto; line-height: 1.5;"><span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">db</span> <span style="color: #ff7700;font-weight:bold;">import</span> models<br />
<br />
<span style="color: #ff7700;font-weight:bold;">import</span> mptt<br />
<br />
<span style="color: #ff7700;font-weight:bold;">class</span> PossessionNew<span style="color: black;">&#40;</span>models.<span style="color: black;">Model</span><span style="color: black;">&#41;</span>:<br />
&nbsp; &nbsp; possname = models.<span style="color: black;">CharField</span><span style="color: black;">&#40;</span>max_length=<span style="color: #ff4500;">50</span>, unique=<span style="color: #008000;">True</span><span style="color: black;">&#41;</span><br />
&nbsp; &nbsp; parent = models.<span style="color: black;">ForeignKey</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'self'</span>, null=<span style="color: #008000;">True</span>, blank=<span style="color: #008000;">True</span>, related_name=<span style="color: #483d8b;">'children'</span><span style="color: black;">&#41;</span><br />
<br />
mptt.<span style="color: black;">register</span><span style="color: black;">&#40;</span>PossessionNew,<span style="color: black;">&#41;</span></div></pre>
<p>Suppose now that you want to <strong>start instantiating the PossessionNew model</strong> (sorry about the name, it&#8217;s just taken out the context of the application I was working on). </p>
<p>In my case I was creating the tree from other data which needed some pre-processing in order to determine the hierarchical information, so I thought I&#8217;d <strong>create first all the instances, and then &#8216;link&#8217; them by setting their <i>.parent</i> attribute as needed</strong>. This turned out to be the <strong><span style='text-decoration:underline;'>wrong way of doing it</span></strong>.<br />
In other words, what I did was this: first, creating the instances, and second, create the relationships. E.g.:</p>
<pre><div class="python" style="font-family:monospace;color: #006; border: 1px solid #d0d0d0; background-color: #f0f0f0;overflow:auto; line-height: 1.5;">bash-<span style="color: #ff4500;">3.2</span>$ ./runshell.<span style="color: black;">my</span><br />
Python 2.5.1 <span style="color: black;">&#40;</span>r251:<span style="color: #ff4500;">54863</span>, Sep <span style="color: #ff4500;">11</span> <span style="color: #ff4500;">2008</span>, <span style="color: #ff4500;">14</span>:<span style="color: #ff4500;">17</span>:<span style="color: #ff4500;">35</span><span style="color: black;">&#41;</span><br />
<span style="color: black;">&#91;</span>GCC 4.0.1 <span style="color: black;">&#40;</span>Apple Computer, Inc. <span style="color: black;">build</span> <span style="color: #ff4500;">5250</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span> on darwin<br />
Type <span style="color: #483d8b;">&quot;help&quot;</span>, <span style="color: #483d8b;">&quot;copyright&quot;</span>, <span style="color: #483d8b;">&quot;credits&quot;</span> <span style="color: #ff7700;font-weight:bold;">or</span> <span style="color: #483d8b;">&quot;license&quot;</span> <span style="color: #ff7700;font-weight:bold;">for</span> more information.<br />
<span style="color: black;">&#40;</span>InteractiveConsole<span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> poms.<span style="color: black;">pomsapp</span>.<span style="color: black;">models</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #66cc66;">*</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p1 = PossessionNew<span style="color: black;">&#40;</span>possname=<span style="color: #483d8b;">&quot;test11&quot;</span><span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p2 = PossessionNew<span style="color: black;">&#40;</span>possname=<span style="color: #483d8b;">&quot;test22&quot;</span><span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p3 = PossessionNew<span style="color: black;">&#40;</span>possname=<span style="color: #483d8b;">&quot;test33&quot;</span><span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p1.<span style="color: black;">save</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p2.<span style="color: black;">save</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p3.<span style="color: black;">save</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p3.<span style="color: black;">parent</span> = p2<br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p2.<span style="color: black;">parent</span> = p1<br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p3.<span style="color: black;">save</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p2.<span style="color: black;">save</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span></div></pre>
<p>Everything seemed to work fine and it also looked fine on the admin interface.<br />
However, <strong>things didn&#8217;t work when trying to use MPTT APIs</strong>. For example, after restarting the shell:</p>
<pre><div class="python" style="font-family:monospace;color: #006; border: 1px solid #d0d0d0; background-color: #f0f0f0;overflow:auto; line-height: 1.5;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> p2 = PossessionNew.<span style="color: black;">objects</span>.<span style="color: black;">get</span><span style="color: black;">&#40;</span>possname=<span style="color: #483d8b;">&quot;test22&quot;</span><span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p2.<span style="color: black;">get_children</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><br />
<span style="color: black;">&#91;</span><span style="color: black;">&#93;</span> &nbsp;<span style="color: #808080; font-style: italic;"># weird!</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p2.<span style="color: black;">get_</span><br />
p2.<span style="color: black;">get_ancestors</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p2.<span style="color: black;">get_descendants</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p2.<span style="color: black;">get_next_sibling</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;p2.<span style="color: black;">get_previous_sibling</span><br />
p2.<span style="color: black;">get_children</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;p2.<span style="color: black;">get_next_by_created_at</span> &nbsp; &nbsp; &nbsp;p2.<span style="color: black;">get_previous_by_created_at</span> &nbsp;p2.<span style="color: black;">get_root</span><br />
p2.<span style="color: black;">get_descendant_count</span> &nbsp; &nbsp; &nbsp; &nbsp;p2.<span style="color: black;">get_next_by_updated_at</span> &nbsp; &nbsp; &nbsp;p2.<span style="color: black;">get_previous_by_updated_at</span> &nbsp;p2.<span style="color: black;">get_siblings</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p2.<span style="color: black;">parent</span><br />
<span style="color: #66cc66;">&lt;</span>PossessionNew: test11<span style="color: #66cc66;">&gt;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p2.<span style="color: black;">children</span>.<span style="color: #008000;">all</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><br />
<span style="color: black;">&#91;</span><span style="color: #66cc66;">&lt;</span>PossessionNew: test33<span style="color: #66cc66;">&gt;</span><span style="color: black;">&#93;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p2.<span style="color: black;">get_ancestors</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><br />
<span style="color: black;">&#91;</span><span style="color: #66cc66;">&lt;</span>PossessionNew: test11<span style="color: #66cc66;">&gt;</span><span style="color: black;">&#93;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p2.<span style="color: black;">get_descendants</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><br />
<span style="color: black;">&#91;</span><span style="color: black;">&#93;</span> <span style="color: #808080; font-style: italic;"># weird!</span></div></pre>
<p>As you can see, we have some erratic behavior here, in fact the <i>get_descendants</i> and other similar methods don&#8217;t produce the desired output.. </p>
<p>I soon realized that the error lies in the fact that when creating children manually &#8211; e.g. by setting the <i>.parent</i> attribute of an instance &#8211; the other fields needed for MPTT to manage the tree are not updated.</p>
<p>So, here&#8217;s the <strong><span style='text-decoration:underline;'>right way of doing this</span></strong>.<br />
When operating with the tree you must <strong>always use the <i>insert_at</i> and <i>move_to</i> methods</strong> that come with the MPTT library. So, for example:</p>
<pre><div class="python" style="font-family:monospace;color: #006; border: 1px solid #d0d0d0; background-color: #f0f0f0;overflow:auto; line-height: 1.5;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> p3 = PossessionNew<span style="color: black;">&#40;</span>possname = <span style="color: #483d8b;">&quot;test333&quot;</span><span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p1 = PossessionNew<span style="color: black;">&#40;</span>possname = <span style="color: #483d8b;">&quot;test111&quot;</span><span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p2 = PossessionNew<span style="color: black;">&#40;</span>possname = <span style="color: #483d8b;">&quot;test222&quot;</span><span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p1.<span style="color: black;">save</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p2.<span style="color: black;">save</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p3.<span style="color: black;">save</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p2.<span style="color: black;">move_to</span><span style="color: black;">&#40;</span>p1<span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p3.<span style="color: black;">move_to</span><span style="color: black;">&#40;</span>p2<span style="color: black;">&#41;</span></div></pre>
<p><span style="font-style: oblique;">[<strong style="background: lavender;">Update 17/11/10:</strong>] almost by chance, I finally understood what the problem was here.. <a href="http://groups.google.com/group/django-mptt-dev/browse_thread/thread/b2c68adde7f4fb92">mptt has a problem with updating instances already stored in memory</a>. What follows is still valid, but there are other ways around the problem too eg. <a href="http://code.google.com/p/django-mptt/issues/detail?id=17">check this link too</a>.</span></p>
<p>Now let&#8217;s check again whether the model inheritance works all right (I usually have to <b>restart the shell</b> in order to check this, otherwise the modifications are not loaded properly. I haven&#8217;t figured out yet why this happens&#8230;):</p>
<pre><div class="python" style="font-family:monospace;color: #006; border: 1px solid #d0d0d0; background-color: #f0f0f0;overflow:auto; line-height: 1.5;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> p2 = PossessionNew.<span style="color: black;">objects</span>.<span style="color: black;">get</span><span style="color: black;">&#40;</span>possname = <span style="color: #483d8b;">&quot;test222&quot;</span><span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p2.<span style="color: black;">get_descendants</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><br />
<span style="color: black;">&#91;</span><span style="color: #66cc66;">&lt;</span>PossessionNew: test333<span style="color: #66cc66;">&gt;</span><span style="color: black;">&#93;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p2.<span style="color: black;">get_ancestors</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><br />
<span style="color: black;">&#91;</span><span style="color: #66cc66;">&lt;</span>PossessionNew: test111<span style="color: #66cc66;">&gt;</span><span style="color: black;">&#93;</span></div></pre>
<p>Now it all makes more sense, doesn&#8217;t it?<br />
Notice that in this case we used the <i><strong>move_to</strong></i> method. We could also have used <i><strong>insert_at</strong></i> (check the <a href="http://django-mptt.github.com/django-mptt/">docs</a>). Remember also that we&#8217;ve been using these methods with instances up to now (=<b>instance methods</b>). If necessary, you could also achieve the same results by means of the TreeManager custom manager (=<b>custom manager methods</b>).<br />
So, for example:</p>
<pre><div class="python" style="font-family:monospace;color: #006; border: 1px solid #d0d0d0; background-color: #f0f0f0;overflow:auto; line-height: 1.5;"><span style="color: #66cc66;">&gt;&gt;&gt;</span> p1 = PossessionNew<span style="color: black;">&#40;</span>possname = <span style="color: #483d8b;">&quot;test11&quot;</span><span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> PossessionNew.<span style="color: black;">tree</span>.<span style="color: black;">insert_node</span><span style="color: black;">&#40;</span>p1, <span style="color: #008000;">None</span>, commit=<span style="color: #008000;">True</span><span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&lt;</span>PossessionNew: test11<span style="color: #66cc66;">&gt;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p2 = PossessionNew<span style="color: black;">&#40;</span>possname = <span style="color: #483d8b;">&quot;test22&quot;</span><span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> PossessionNew.<span style="color: black;">tree</span>.<span style="color: black;">insert_node</span><span style="color: black;">&#40;</span>p2, p1, commit=<span style="color: #008000;">True</span><span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&lt;</span>PossessionNew: test22<span style="color: #66cc66;">&gt;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> p3 = PossessionNew<span style="color: black;">&#40;</span>possname = <span style="color: #483d8b;">&quot;test33&quot;</span><span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&gt;&gt;&gt;</span> PossessionNew.<span style="color: black;">tree</span>.<span style="color: black;">insert_node</span><span style="color: black;">&#40;</span>p3, p2, commit=<span style="color: #008000;">True</span><span style="color: black;">&#41;</span><br />
<span style="color: #66cc66;">&lt;</span>PossessionNew: test33<span style="color: #66cc66;">&gt;</span></div></pre>
<p>That&#8217;s it. Follows a list of the model instance methods <a href="http://django-mptt.github.com/django-mptt/models.html#mpttmodel-instance-methods">MPTT makes available</a>:</p>
<blockquote><p><strong>get_ancestors(ascending=False)</strong> &#8212; creates a QuerySet containing the ancestors of the model instance. These default to being in descending order (root ancestor first, immediate parent last); passing True for the ascending argument will reverse the ordering (immediate parent first, root ancestor last).</p>
<p><strong>get_children()</strong> &#8212; creates a QuerySet containing the immediate children of the model instance, in tree order. The benefit of using this method over the reverse relation provided by the ORM to the instance&#8217;s children is that a database query can be avoided in the case where the instance is a leaf node (it has no children).</p>
<p><strong>get_descendants(include_self=False)</strong> &#8212; creates a QuerySet containing descendants of the model instance, in tree order.<br />
If include_self is True, the QuerySet will also include the model instance itself.</p>
<p><strong>get_descendant_count()</strong> &#8212; returns the number of descendants the model instance has, based on its left and right tree node edge indicators. As such, this does not incur any database access.</p>
<p><strong>get_next_sibling()</strong> &#8212; returns the model instance&#8217;s next sibling in the tree, or None if it doesn&#8217;t have a next sibling.</p>
<p><strong>get_previous_sibling()</strong> &#8212; returns the model instance&#8217;s previous sibling in the tree, or None if it doesn&#8217;t have a previous sibling.</p>
<p><strong>get_root()</strong> &#8212; returns the root node of the model instance&#8217;s tree.</p>
<p><strong>get_siblings(include_self=False)</strong> &#8212; creates a QuerySet containing siblings of the model instance. Root nodes are considered to be siblings of other root nodes. If include_self is True, the QuerySet will also include the model instance itself.</p>
<p><strong>insert_at(target, position=&#8217;first-child&#8217;, commit=False)</strong> &#8212; positions the model instance (which must not yet have been inserted into the database) in the tree based on target and position (when appropriate). If commit is True, the model instance&#8217;s save() method will be called before the instance is returned.</p>
<p><strong>is_child_node()</strong> &#8212; returns True if the model instance is a child node, False otherwise.</p>
<p><strong>is_leaf_node()</strong> &#8212; returns True if the model instance is a leaf node (it has no children), False otherwise.</p>
<p><strong>is_root_node()</strong> &#8212; returns True if the model instance is a root node, False otherwise.</p>
<p><strong>move_to(target, position=&#8217;first-child&#8217;)</strong> &#8212; moves the model instance elsewhere in the tree based on target and position (when appropriate).</p></blockquote>
<p>&nbsp;</p>
				
			<!-- <script src="http://digg.com/tools/diggthis.js" type="text/javascript"></script> -->
			<!-- AddToAny BEGIN -->
			<a class="a2a_dd" href="http://www.addtoany.com/share_save"><img src="http://static.addtoany.com/buttons/share_save_256_24.png" width="256" height="24" border="0" alt="Share/Bookmark"/></a>
			<script type="text/javascript" src="http://static.addtoany.com/menu/page.js"></script>
			<!-- AddToAny END -->
			
			
						</div><!-- end entry --><br/><br/>
	</div><!-- end post -->
	<ul class="post">
		<li><b>META</b> / ABOUT THIS POST</li>
		<li>This entry was posted
									on Tuesday, September 15th, 2009 at 4:35 pm			and is filed under <a href="../../../../category/techlife/index.html" rel="category tag">TechLife</a>. Tags: <a href="../../../../tag/django/index.html" rel="tag">django</a>, <a href="../../../../tag/mptt/index.html" rel="tag">mptt</a>, <a href="../../../../tag/tree/index.html" rel="tag">tree</a>.
			You can follow any responses to this entry through the <a href="feed/index.html">RSS 2.0</a> feed.

									Both comments and pings are currently closed.

								</li>
	</ul><br/><br/>
	<ul class="post">
		<li><b>PAGES</b> / FORWARD OR BACK?</li>
		<li>Previous: <a href="../../13/learning-iphone-development-while-sitting-on-your-couch/index.html" rel="prev">Learning iPhone development while sitting on your couch</a></li>
		<li>Next: <a href="../../28/project-django-soclone/index.html" rel="next">Project: django SOCLONE</a></li>
	</ul><br/><br/>
					
							
			
	
<!-- You can start editing here. -->

<h3 class="comments"><span class="dsq-postid" data-dsqidentifier="318 http://magicrebirth.wordpress.com/?p=318">10 Responses</span> to &#8220;Using Django-MPTT: lessons learned&#8230;&#8221;
</h3>

	<div class="alt bubble" id="comment-97">
	<blockquote><p>Hey there,<br />
Great site, I just found it and I am already a fan.</p>
</blockquote>
	<cite><a href='http://www.alexa.com/siteinfo/jibbl.info' rel='external nofollow' class='url'>Computers &amp; Tech</a> added these pithy words on <a href="index.html#comment-97" title="">Sep 19 09 at 7:10 am</a> 	</cite> 
			</div>

	
	<div class=" bubble" id="comment-98">
	<blockquote><p>cool!</p>
</blockquote>
	<cite><a href='http://magicrebirth.wordpress.com/' rel='external nofollow' class='url'>magicrebirth</a> added these pithy words on <a href="index.html#comment-98" title="">Sep 28 09 at 11:59 am</a> 	</cite> 
			</div>

	
	<div class="alt bubble" id="comment-99">
	<blockquote><p>Thanks for that.  Just starting with mptt and I think you saved me from a lot of frustration!</p>
</blockquote>
	<cite><a href='http://pbjots.blogspot.com' rel='external nofollow' class='url'>Phoebe Bright</a> added these pithy words on <a href="index.html#comment-99" title="">Sep 29 09 at 8:59 pm</a> 	</cite> 
			</div>

	
	<div class=" bubble" id="comment-100">
	<blockquote><p>Just wondered if you had experimented with mptt and inherited models.  Havn&#8217;t been able to get it working myself and looking around to see if anyone else has.<br />
Abstract inheritance will work only if you want the child classes to only have parents in the same child class.  Non-abstract inheritance doesn&#8217;t work at all.</p>
<p>This is where I got to:<br />
<a href="http://groups.google.com/group/django-users/browse_thread/thread/777c903177d09970#" rel="nofollow">http://groups.google.com/group/django-users/browse_thread/thread/777c903177d09970#</a></p>
</blockquote>
	<cite><a href='http://pbjots.blogspot.com' rel='external nofollow' class='url'>Phoebe Bright</a> added these pithy words on <a href="index.html#comment-100" title="">Oct 05 09 at 10:20 am</a> 	</cite> 
			</div>

	
	<div class="alt bubble" id="comment-101">
	<blockquote><p>hi phoebe &#8211; no I didn&#8217;t do much experimentation with that, although I noticed that normal inheritance didn&#8217;t work. I suppose that&#8217;s because the &#8216;lft&#8217;, &#8216;rgt&#8217; fields (and the other ones MPTT creates by default for managing the hierarchy) are being created only in the superclasses&#8230; maybe the other django-tree framework does better in this respect [http://code.google.com/p/django-treebeard/] ?<br />
Let me know how it goes!</p>
</blockquote>
	<cite><a href='http://magicrebirth.wordpress.com/' rel='external nofollow' class='url'>magicrebirth</a> added these pithy words on <a href="index.html#comment-101" title="">Oct 05 09 at 11:28 am</a> 	</cite> 
			</div>

	
	<div class=" bubble" id="comment-102">
	<blockquote><p>Great info here on mptt!  This is the only example I can recall seeing where someone showed an actual real world model using mptt.  In your example, would not one also need to update the parent attribute as well after using move_to so that both methods would work afterward?  Maybe something could be added to the model to automatically do move_to if the parent object changes&#8230;</p>
</blockquote>
	<cite>mike added these pithy words on <a href="index.html#comment-102" title="">Oct 08 09 at 2:58 pm</a> 	</cite> 
			</div>

	
	<div class="alt bubble" id="comment-103">
	<blockquote><p>thank you!  i made this exact same mistake and it bit me in the ass.  Now i know.  The docs aren&#8217;t very clear on this part:</p>
<p>always use insert_at or move_to!</p>
</blockquote>
	<cite>brett added these pithy words on <a href="index.html#comment-103" title="">Oct 21 09 at 9:00 pm</a> 	</cite> 
			</div>

	
	<div class=" bubble" id="comment-104">
	<blockquote><p>edit !<br />
p1 = PossessionNew(possname=&#8221;test11&#8243;)<br />
-&gt;<br />
p1 = PossessionNew(name=&#8221;test11&#8243;)<br />
&#8230;</p>
</blockquote>
	<cite><a href='http://www.meganova.com' rel='external nofollow' class='url'>ganbolor</a> added these pithy words on <a href="index.html#comment-104" title="">Jan 09 10 at 10:44 am</a> 	</cite> 
			</div>

	
	<div class="alt bubble" id="comment-105">
	<blockquote><p>thanks!</p>
</blockquote>
	<cite>mike added these pithy words on <a href="index.html#comment-105" title="">Nov 04 10 at 5:16 pm</a> 	</cite> 
			</div>

	
	<div class=" bubble" id="comment-106">
	<blockquote><p>Thanks a ton !</p>
</blockquote>
	<cite><a href='http://blog.kiranruth.com' rel='external nofollow' class='url'>Kiran Ruth R</a> added these pithy words on <a href="index.html#comment-106" title="">Aug 27 12 at 11:20 am</a> 	</cite> 
			</div>

	
	

 


	</div><!-- end content -->	
<div id="sidebar">


	<p class="menu"><B>INSIDE&nbsp;&nbsp;&nbsp;&nbsp;&larr;</b></p><br/>
		<p><a href="../../../../index.html">Parerga und Paralipomena</a></p>
		<li id="pages-2" class="widget widget_pages"><h2 class="widgettitle">Pages</h2>
		<ul>
			<li class="page_item page-item-532"><a href="../../../../about-2/index.html">About Me</a></li>
<li class="page_item page-item-3355"><a href="../../../../latest-from-twitter/index.html">Latest from Twitter</a></li>
		</ul>
			</li>
<li id="categories-2" class="widget widget_categories"><h2 class="widgettitle">Categories</h2>
		<ul>
				<li class="cat-item cat-item-408"><a href="../../../../category/computermusic/index.html">Computer Music</a>
</li>
	<li class="cat-item cat-item-3"><a href="../../../../category/culturalinformatics/index.html">Cultural Informatics</a>
</li>
	<li class="cat-item cat-item-455"><a href="../../../../category/data-science/index.html">Data science</a>
</li>
	<li class="cat-item cat-item-4"><a href="../../../../category/informationarchitecture/index.html">Information Architecture</a>
</li>
	<li class="cat-item cat-item-5"><a href="../../../../category/justblogging/index.html">Just Blogging</a>
</li>
	<li class="cat-item cat-item-6"><a href="../../../../category/semantic-web/index.html">Semantic Web</a>
</li>
	<li class="cat-item cat-item-7"><a href="../../../../category/techlife/index.html">TechLife</a>
</li>
	<li class="cat-item cat-item-8"><a href="../../../../category/tips-and-tricks/index.html">Tips and Tricks</a>
</li>
		</ul>
			</li>
 
		
		<!-- mikele: the stuff above doesn't get activated so I put it here -->
<br/><br/>
		<ul style="text-align:right;">

			<p><b>FIND</b> / SEARCH</p>
			<form method="get" id="search_form" action="../../../../index.html">
				<input type="text" class="search_input" value="Type and hit enter..." name="s" id="s" onfocus="if (this.value == 'Type and hit enter...') {this.value = '';}" onblur="if (this.value == '') {this.value = 'Type and hit enter...';}" />
				<input type="hidden" id="searchsubmit" value="Search" />
			</form>
		</ul><br/>


<!-- 	
		<!-- mikele: adsense 
		<br/>
                 <ul style="text-align:right;">
		<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

		<ins class="adsbygoogle"
		     style="display:block"
		     data-ad-client="ca-pub-8108687655438913"
		     data-ad-slot="2230044782"
		     data-ad-format="auto"></ins>
		<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
		</script>
                </ul><br/> 
-->

		
		
		
	</div><!-- end sidebar --><div class="footer">
	<p><b>FOOTER</b> / LEST WE FORGET<br/>
<!-- If you'd like to support WordPress, having the "powered by" link someone on your blog is the best way, it's our only promotion or advertising. -->

<!-- Change this theme as you wish, but PLEASE keep a visible link to http://www.upstartblogger.com/ somewhere on every page of your blog (for example, in the sidebar or footer). You aren't going to delete the WordPress link, are you? Please don't delete mine. Thanks! -->
		Copyright &copy; 2004-2007 by Parerga und Paralipomena, unless otherwise noted. All rights reserved. Powered by <a href="http://wordpress.org/" title="WordPress">WordPress</a>. Original Modio theme by <a href="http://www.upstartblogger.com/" title="Upstart Blogger">Upstart Blogger</a>, modified by Michele Pasin.






</p>
	<!-- 45 queries. 0.315 seconds. -->





</div><!-- end footer -->

<!-- Start of Flickr Badge -->
<style type="text/css">
#flickr_badge_source_txt {padding:0; font: 11px Arial, Helvetica, Sans serif; color:#666666;}
#flickr_badge_icon {display:block !important; margin:0 !important; border: 1px solid rgb(0, 0, 0) !important;}
#flickr_icon_td {padding:0 5px 0 0 !important;}
.flickr_badge_image {text-align:center !important;}
.flickr_badge_image img {border: 1px solid black !important;}
#flickr_www {display:block; padding:0 10px 0 10px !important; font: 11px Arial, Helvetica, Sans serif !important; color:#3993ff !important;}
#flickr_badge_uber_wrapper table {margin-left:265px; margin-top:50px; position:absolute;}
#flickr_badge_uber_wrapper a:hover,
#flickr_badge_uber_wrapper a:link,
#flickr_badge_uber_wrapper a:active,
#flickr_badge_uber_wrapper a:visited {text-decoration:none !important; background:inherit !important;color:#3993ff;}
#flickr_badge_wrapper {background-color:#ffffff;border: solid 1px #000000}
#flickr_badge_source {padding:0 !important; font: 11px Arial, Helvetica, Sans serif !important; color:#666666 !important;}
</style>
<table id="flickr_badge_uber_wrapper" cellpadding="0" cellspacing="10" border="0"><tr><td><table cellpadding="0" cellspacing="10" border="0" id="flickr_badge_wrapper">
<tr>
<script type="text/javascript" src="http://www.flickr.com/badge_code_v2.gne?count=5&display=random&size=s&layout=h&source=user&user=76186999%40N00"></script>
</tr>
</table>
</td></tr></table>
<!-- End of Flickr Badge -->


</div><!-- end page -->
<!-- Powered by WPtouch: 4.3.39 -->	<div style="display:none">
	</div>
<script type='text/javascript' src='https://secure.gravatar.com/js/gprofiles.js?ver=2021Augaa'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var WPGroHo = {"my_hash":""};
/* ]]> */
</script>
<script type='text/javascript' src='../../../../wp-content/plugins/jetpack/modules/wpgroho.js%3Fver=5.2.11'></script>
<script type='text/javascript' src='../../../../wp-includes/js/wp-embed.min.js%3Fver=5.2.11'></script>
<script type='text/javascript' src='https://stats.wp.com/e-202134.js' async='async' defer='defer'></script>
<script type='text/javascript'>
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:8.1.2',blog:'13825966',post:'318',tz:'0',srv:'www.michelepasin.org'} ]);
	_stq.push([ 'clickTrackerInit', '13825966', '318' ]);
</script>
</body>
</html>